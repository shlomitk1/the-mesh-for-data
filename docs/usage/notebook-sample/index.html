<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><title>Kubeflow notebook sample - Mesh for Data</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel=icon href=https://ibm.github.io/the-mesh-for-data/favicon.png><link rel=stylesheet href=/the-mesh-for-data/css/style.min.3dea6367d70c56e79acec88bd5217c58299cb81f7dd3f7a663517f3f971ab627.css></head><body class="page page-default-single"><div id=main-menu-mobile class=main-menu-mobile><ul><li class=menu-item-home><a href=/the-mesh-for-data/><span>Home</span></a></li><li class=menu-item-docs><a href=/the-mesh-for-data/docs/><span>Docs</span></a></li><li class=menu-item-contribute><a href=/the-mesh-for-data/contribute/><span>Contribute</span></a></li></ul></div><div class=wrapper><div class=header><div class=container><div class=logo><a href=https://ibm.github.io/the-mesh-for-data/><img alt=Logo src=/the-mesh-for-data/images/logo.svg></a></div><div class=logo-mobile><a href=https://ibm.github.io/the-mesh-for-data/><img alt=Logo src=/the-mesh-for-data/images/logo.svg></a></div><div id=main-menu class=main-menu><ul><li class=menu-item-home><a href=/the-mesh-for-data/><span>Home</span></a></li><li class=menu-item-docs><a href=/the-mesh-for-data/docs/><span>Docs</span></a></li><li class=menu-item-contribute><a href=/the-mesh-for-data/contribute/><span>Contribute</span></a></li><li><a href=https://github.com/IBM/the-mesh-for-data style=color:#000 class=border-left><i class="fab fa-github fa-2x"></i></a></li></ul></div><button id=toggle-main-menu-mobile class="hamburger hamburger--slider" type=button>
<span class=hamburger-box><span class=hamburger-inner></span></span></button></div></div><div class="container pt-2 pt-md-6 pb-3 pb-md-6"><div class=row><div class="col-12 col-md-3 mb-3"><div class="d-none d-lg-block"><nav id=sidebar aria-label="Section Navigation"><div class=directory><div class=card><button class="header dynamic" id=card4 aria-controls=card4-body>Overview</button><div class=body aria-labelledby=card4 role=region id=card4-body><ul role=tree aria-expanded=true class=leaf-section aria-labelledby=card4><li role=none><a role=treeitem title=() href=https://ibm.github.io/the-mesh-for-data/docs/overview/what-is/>Introduction</a></li><li role=none><a role=treeitem title=() href=https://ibm.github.io/the-mesh-for-data/docs/overview/architecture/>Architecture</a></li><li role=none><a role=treeitem title=() href=https://ibm.github.io/the-mesh-for-data/docs/overview/connectors/>Connectors</a></li><li role=none><a role=treeitem title=() href=https://ibm.github.io/the-mesh-for-data/docs/overview/modules/>Modules</a></li></ul></div></div><div class=card><button class="header dynamic" id=card8 aria-controls=card8-body>Setup</button><div class=body aria-labelledby=card8 role=region id=card8-body><ul role=tree aria-expanded=true class=leaf-section aria-labelledby=card8><li role=none><a role=treeitem href=https://ibm.github.io/the-mesh-for-data/docs/setup/quickstart/>Quick Start</a></li><li role=none><a role=treeitem href=https://ibm.github.io/the-mesh-for-data/docs/setup/install/>Install</a></li><li role=none><a role=treeitem href=https://ibm.github.io/the-mesh-for-data/docs/setup/control-plane-security/>Control Plane Security</a></li><li role=none><a role=treeitem href=https://ibm.github.io/the-mesh-for-data/docs/setup/egeria/install/>ODPi Egeria Install</a></li></ul></div></div><div class=card><button class="header dynamic" id=card14 aria-controls=card14-body>Usage</button><div class="body default" aria-labelledby=card14 role=region id=card14-body><ul role=tree aria-expanded=true class=leaf-section aria-labelledby=card14><li role=none><span role=treeitem class=current>Kubeflow notebook sample</span></li><li role=none><a role=treeitem href=https://ibm.github.io/the-mesh-for-data/docs/usage/opa/update_policies/>Using OPA</a></li></ul></div></div><div class=card><button class="header dynamic" id=card17 title="Detailed authoritative reference material such as command-line options, configuration options, and API calling parameters." aria-controls=card17-body>Reference</button><div class=body aria-labelledby=card17 role=region id=card17-body><ul role=tree aria-expanded=true aria-labelledby=card17><li role=none><a role=treeitem title=() href=https://ibm.github.io/the-mesh-for-data/docs/reference/roadmap/>Roadmap</a></li><li role=treeitem aria-label="API Reference"><button aria-hidden=true></button><a title=() href=https://ibm.github.io/the-mesh-for-data/docs/reference/api/>API Reference</a><ul role=group aria-expanded=false class=leaf-section><li role=none><a role=treeitem href=https://ibm.github.io/the-mesh-for-data/docs/reference/api/generated/connectors.pb/>connectors</a></li><li role=none><a role=treeitem href=https://ibm.github.io/the-mesh-for-data/docs/reference/api/generated/app/>app.m4d.ibm.com</a></li><li role=none><a role=treeitem href=https://ibm.github.io/the-mesh-for-data/docs/reference/api/generated/motion/>motion.m4d.ibm.com</a></li></ul></li><li role=treeitem aria-label=Components><button aria-hidden=true></button><a title=() href=https://ibm.github.io/the-mesh-for-data/docs/reference/components/>Components</a><ul role=group aria-expanded=false class=leaf-section><li role=none><a role=treeitem title=() href=https://ibm.github.io/the-mesh-for-data/docs/reference/components/ddc/>Data Distribution Controller v1.0</a></li></ul></li></ul></div></div></div></nav></div></div><div class="col-12 col-md-9"><nav aria-label=Breadcrumb><ol class=breadcrumb><li class=breadcrumb-item><a href=https://ibm.github.io/the-mesh-for-data/>Mesh for Data</a></li><li class=breadcrumb-item><a href=https://ibm.github.io/the-mesh-for-data/docs/>Docs</a></li><li class=breadcrumb-item><a href=https://ibm.github.io/the-mesh-for-data/docs/usage/>Usage</a></li><li class=breadcrumb-item>Kubeflow notebook sample</li></ol></nav><h1 class=title>Kubeflow notebook sample</h1><div class="content anchor-link-enabled"><p>This sample shows how to run a Kubeflow notebook with Mesh for Data and demonstrates how polices are seamlessly applied when accessing a dataset.</p><h2 id=before-you-begin>Before you begin</h2><p>Ensure that you have the following:</p><ul><li><code>kubectl</code> with access to a Kubernetes cluster (this guide was tested with kind v0.10.0 and OpenShift 4.3)</li><li>Mesh for Data installed on your Kubernetes cluster</li><li>S3 Object storage account (e.g., Ceph, Minio, IBM Cloud Object Storage)</li><li><a href=https://www.kubeflow.org/>Kubeflow</a> installed on your cluster (this guide was tested with Kubeflow v1.0.2)</li><li>Web browser</li></ul><div class="alert alert-info" role=alert><i class="fas fa-info-circle" style=padding-right:1em aria-hidden=true></i>You can install Kubeflow on Kind by running <a href=https://github.com/IBM/the-mesh-for-data/blob/master/samples/kubeflow/install/kubeflow/install_kubeflow.sh>install_kubeflow.sh</a>.
For OpenShift follow <a href=https://github.com/IBM/the-mesh-for-data/blob/master/samples/kubeflow/install/kubeflow/KF_OPENSHIFT.md>KF_OPENSHIFT.md</a>.</div><h2 id=about-this-sample>About this sample</h2><p>In this sample guide you will run a Kubeflow notebook with Mesh for Data and demonstrate that data read polices that are defined in Open Policy Agent (OPA) are seamlessly applied when reading a dataset.</p><p>In this sample guide you will:</p><ol><li>Prepare a dataset to be accessed by the notebook</li><li>Register the dataset in ODPi Egeria catalog</li><li>Register the dataset credentials in Vault</li><li>Deploy a Kubeflow notebook</li><li>Create a Mesh for Data runtime environment for the notebook</li><li>Read the dataset and observe policies applied seamlessly</li></ol><h2 id=getting-started>Getting started</h2><p>Completed all the steps in <a href=https://ibm.github.io/the-mesh-for-data/docs/setup/quickstart/>quick start guide</a>.</p><h2 id=prepare-the-dataset-for-the-sample-notebook>Prepare the dataset for the sample notebook</h2><ol><li><p>Upload <a href=https://github.com/IBM/the-mesh-for-data/blob/master/samples/kubeflow/data.csv>data.csv</a> to an object storage of your choice
<code>data.csv</code> contains the first 100 rows from the following <a href=https://www.kaggle.com/ntnu-testimon/paysim1/data>data set</a> created by NTNU, and it is shared under the <em><strong>CC BY-SA 4.0</strong></em> license.</p></li><li><p>Update <code>samples/kubeflow/example_transactions.csv.json</code> with the location of the dataset, The location is encoded in the <code>fullPath</code> field as follows:</p><ul><li>Bucket: Change the <code>bucket</code> value from <code>m4d-bucket-example</code> to the bucket name where the dataset reside.</li><li>endpoint: Change the S3 endpoint name from <code>s3.eu-de.cloud-object-storage.appdomain.cloud</code> to the object storage endpoint</li><li>object_key: If needed, change object_key from <code>data.csv</code> to the object name that you used in the previous step.
For more information on the content please see the comments in <a href=https://github.com/IBM/the-mesh-for-data/blob/master//third_party/egeria/usage/create_new_asset.sh>third_pary/egeria/usage/create_new_asset.sh</a> for more details.</li></ul></li><li><p>Register the dataset in the catalog</p><ul><li><p>Setup port forwarding for communicating with Egeria</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=nb>cd</span> third_party/egeria/usage
kubectl port-forward -n egeria-catalog svc/lab-core 9443:9443 <span class=p>&amp;</span>
</code></pre></div></li><li><p>Wait for the port-forward to take effect.</p></li><li><p>Register the dataset in the catalog with the tag &lsquo;finance&rsquo;.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>./create_new_asset.sh ../../../samples/kubeflow/example_transactions.csv.json <span class=s1>&#39;finance&#39;</span>
</code></pre></div></li><li><p>Cleanup the port forwarding using the following.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=nb>cd</span> -
<span class=nb>kill</span> <span class=nv>$!</span>
</code></pre></div></li></ul></li><li><p>Record the asset id for the dataset. It will be displayed as part of the output from the previous step and export it to environment variable. An example for an asset id is <code>5de27155-48d3-4d78-8767-73e7b264e394</code></p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>export ASSET_ID=&lt;asset-id&gt;
</code></pre></div></li><li><p>Store the object dataset credentials in Vault to make them available for Mesh for Data. Currently only hmac credentials are supported, and the <code>access_key</code> (a.k.a <code>access_key_id</code>) and <code>secret_key</code> (a.k.a <code>secret_access_key</code>) should be associated with the asset id.</p><p>You can register the credentials using a browser and Vault&rsquo;s UI to upload the credentials.</p><ul><li><p>Setup port forwarding to communicate with Vault.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>kubectl port-forward -n m4d-system svc/vault 8200:8200 <span class=p>&amp;</span>
</code></pre></div></li><li><p>Open <code>http://localhost:8200</code> a your browser, select <code>method</code> as <code>username</code> and login using username <code>data_provider</code> and password <code>password</code>.</p></li><li><p>Click <code>/external</code> and then <code>Create secret</code></p></li><li><p>Create the following secret:</p><ul><li>Path for this secret: <code>{"ServerName":"cocoMDS3","AssetGuid":"&lt;asset ID>"}</code>. For example, <code>{"ServerName":"cocoMDS3" , "AssetGuid":"5de27155-48d3-4d78-8767-73e7b264e394"}</code></li><li>Secret data key: <code>&lt;access-key-id></code></li><li>Secrey data value: <code>&lt;secret-access-key></code></li></ul></li><li><p>Click <code>save</code></p></li></ul><p>Note: The path is a reference to the Egeria metadata server and asset id. In the default Egeria installation <code>cocoMDS3</code> is the metadata server name.</p><ul><li><p>Finally, kill the port-forward</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=nb>kill</span> <span class=nv>$!</span>
</code></pre></div></li></ul></li></ol><h2 id=reviewing-the-policies-for-the-dataset>Reviewing the policies for the dataset</h2><p>Currently predefined policies are included as part of the OPA deployment.
Included are policies that are triggered for datasets that are tagged with &lsquo;finance&rsquo; and have columns <code>nameOrig</code> and <code>nameDest</code>. The policies indicate that these columns must be redacted (masked) when data is read.</p><p>The policies can be found at <code>third_party/opa/opa-policy.rego</code>.</p><h2 id=setup-the-notebook>Setup the notebook</h2><p>Next you will create a Kubeflow notebook server and a notebook with the business logic for creating a fraud detection model.</p><ol><li><p>Create a port-forward to communicate with Kubeflow:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>kubectl port-forward svc/istio-ingressgateway -n istio-system 8080:80 <span class=p>&amp;</span>
<span class=nb>cd</span> samples/kubeflow/
</code></pre></div></li><li><p>Upload the notebook:</p><ul><li>Open your browser and go to <code>http://localhost:8080</code>.</li><li>Click <strong>Start Setup</strong> and then <strong>Finish</strong> (use the <code>anonymous</code> namespace).</li><li>Click <strong>Notebook Servers</strong> (in the left).</li><li>In the notebooks page select in the top left the <code>anonymous</code> namespace and then click <strong>New Server</strong>.</li><li>In the notebook server creation page, set <code>kf-notebook</code> in the <strong>Name</strong> box and then click <strong>Launch</strong>. Wait for the server to become ready.</li><li>Click <strong>Connect</strong> and upload <code>kfM4DPolicySample.ipynb</code> notebook to the server.</li></ul></li></ol><h2 id=run-the-notebook-with-hahahugoshortcode-s11-hbhb>Run the notebook with Mesh for Data</h2><p>Now you will deploy a Mesh for Data runtime environment for the notebook by creating a <code>M4DApplication</code> resource that references the <code>data.csv</code> data set that was registered in the data catalog.
This allows the code in the notebook to read the data and policies to seamlessly be applied before the data reaches the notebook server.</p><ol><li><p>Create the <code>M4DApplication</code> resource which will deploy Mesh for Data runtime environment by running the following:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>cat m4dapplication.yaml <span class=p>|</span> sed <span class=s2>&#34;s/ASSET_ID/</span><span class=nv>$ASSET_ID</span><span class=s2>/g&#34;</span> <span class=p>|</span> kubectl -n anonymous apply -f -
<span class=nb>cd</span> -
</code></pre></div></li><li><p>Before running the notebook you need to modify the following statements in the <code>Get Data</code> cell in the notebook:</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=o>...</span>
<span class=n>client</span> <span class=o>=</span> <span class=n>fl</span><span class=o>.</span><span class=n>connect</span><span class=p>(</span><span class=s2>&#34;grpc://&lt;arrow-flight-module-service&gt;.&lt;arrow-flight-module-ns&gt;.svc.  cluster.local:80&#34;</span><span class=p>)</span>

<span class=n>request</span> <span class=o>=</span> <span class=p>{</span>
<span class=s2>&#34;asset&#34;</span><span class=p>:</span> <span class=s2>&#34;&lt;bucket-name&gt;/&lt;file-name&gt;.csv&#34;</span><span class=p>,</span> 
<span class=s2>&#34;columns&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;step&#34;</span><span class=p>,</span> <span class=s2>&#34;type&#34;</span><span class=p>,</span> <span class=s2>&#34;amount&#34;</span><span class=p>,</span> <span class=s2>&#34;nameOrig&#34;</span><span class=p>,</span> <span class=s2>&#34;oldbalanceOrg&#34;</span><span class=p>,</span> <span class=s2>&#34;newbalanceOrig&#34;</span><span class=p>,</span> <span class=s2>&#34;nameDest&#34;</span><span class=p>,</span> <span class=s2>&#34;oldbalanceDest&#34;</span><span class=p>,</span> <span class=s2>&#34;newbalanceDest&#34;</span><span class=p>,</span> <span class=s2>&#34;isFraud&#34;</span><span class=p>,</span> <span class=s2>&#34;isFlaggedFraud&#34;</span><span class=p>]</span>
<span class=p>}</span>
<span class=o>...</span>
</code></pre></div><ul><li><p>Edit the <code>client = fl.connect(...)</code> command to point to the right service and namespace of the arrow-flight-module.</p></li><li><p>To find the service and namespace run:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>kubectl get svc -l app.kubernetes.io/name<span class=o>=</span>arrow-flight-module --all-namespaces
</code></pre></div></li><li><p>Edit <code>"asset": "&lt;bucket-name>/&lt;file-name>.csv"</code> in the second command to point to your bucket and the name of the dataset.</p></li></ul></li><li><p>Run the notebook</p><p>You should observe in the cell <code>Get Data</code> the data from the dataset.</p></li><li><p>Finally, kill the port-forward</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=nb>kill</span> <span class=nv>$!</span>
</code></pre></div></li></ol><h1 id=next-steps>Next steps</h1><p>You have completed an execution of a notebook with Mesh for Data and are now ready to continue exploring.</p></div></div></div></div></div></div><div class=sub-footer><div class=container><div class=row><div class=col-12><div class=sub-footer-inner><ul><li class=fineprint><a href=https://ibm.github.io/the-mesh-for-data/legal>fine print</a></li></ul></div></div></div></div></div><script type=text/javascript src=/the-mesh-for-data/js/scripts.min.743d9793278e564da4ce594a32a52b65cbd1df69adbfc11858d0093e9a230182.js></script></body></html>